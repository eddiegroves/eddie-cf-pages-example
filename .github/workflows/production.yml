name: Deploy to Cloudflare Pages
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-22.04
    steps:
      ###############################
      # - name: Checkout            #
      #   uses: actions/checkout@v2 #
      # - name: Build               #
      #   run: make build           #
      ###############################
      - name: Create gh deployment
        run: |
          curl \
          -X POST \
          https://api.github.com/repos/${{ github.repository }}/deployments \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ github.token }}" \
          -d '{"ref":"main","auto_merge":false,"environment":"production","production_environment":true,"description":"Cloudflare Pages","required_contexts":[]}' | jq ".id | xargs -I {} ::set-output name=gh_deployment_id::{}"
      - name: Update gh deployment status
        run: |
          curl \
          -X POST \
          https://api.github.com/repos/${{ github.repository }}/deployments/${{ steps.vars.outputs.gh_deployment_id }}/statuses \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ github.token }}" \
          -d '{"environment":"production","state":"success","description":"Cloudflare Pages deployment finished successfully."}'
      ###################################################################
      # - name: Deploy production                                       #
      #   run: |                                                        #
      #     npx wrangler@2.0.29 pages publish dist/ \                   #
      #     --project-name=eddie-cf-pages-example \                     #
      #     --branch=production \                                       #
      #     --commit-hash=${{ github.sha }} \                           #
      #     --commit-message="${{github.event.head_commit.message}}"    #
      #   env:                                                          #
      #     CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }} #
      #     CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}   #
      ###################################################################
